# Kernel-based Virtual Machine Usage

- [Start service](#start-service)
- [Virtual networks](#virtual-networks)
- [Shared directory](#shared-directory)
   - [Linux guest](#linux-guest)
   - [Windows guest](#windows-guest)
- [GPU passthrough](#gpu-passthrough)
   - [Windows guest](#windows-guest-1)

For installation, see:

- [[Tumbleweed/dev_env#KVM]]

## Start service

Before running Virtual Machine Manager, enable related services via the following commands:

```bash
systemctl start libvirtd.service
```

The following alias can be set for convenience:

```bash
alias vstart='sudo systemctl start libvirtd.service && systemctl status libvirtd.service && sudo virsh net-start default && sudo virsh net-list --all && virt-manager'
```

*References*:

- [7.1 Starting and stopping the monolithic daemon](https://doc.opensuse.org/documentation/leap/virtualization/single-html/book-virtualization/#libvirt-monolithic-daemon)

## Virtual networks

At the time of writing (*Tumbleweed 20230118*), first disable WARP then enable WARP.

*References*:

- [XML format](https://wiki.libvirt.org/VirtualNetworking.html#xml-format)
- [What is the difference between virbr# and vnet#?](https://unix.stackexchange.com/questions/52855/what-is-the-difference-between-virbr-and-vnet)
- [WARP breaks KVM/libvirt networking on Linux (Virt-manager)](https://community.cloudflare.com/t/warp-breaks-kvm-libvirt-networking-on-linux-virt-manager/533205)

## Shared directory

### Linux guest

1. Enable shared memory:

   ![Enable shared memory](attachments/shared_mem.png)

2. Add hardware:

   ![Add hardware](attachments/add_hw.png)

   Then edit XML as follows:

   ```xml
   <filesystem type="mount" accessmode="passthrough">
     <source dir="HOST_SHARE_PATH"/>
     <target dir="GUEST_SHARE_PATH"/>
     <driver type="virtiofs"/>
   </filesystem>
   ```

   Note that for old distro having kernel version lower than *Linux v5.4* (e.g. *Ubuntu 16.04*), `9p` should be used instead of `virtiofs`. Supported FS could be checked via the following commands:

   ```bash
   cat /etc/filesystems
   cat /proc/filesystems
   ls /lib/modules/$(uname -r)/kernel/fs
   ```

3. Mount the shared directory within the guest operating system via the following commands:

   ```bash
   mkdir -v ~/shared
   sudo mount -t virtiofs GUEST_SHARE_PATH ~/shared
   ```

*References*:

- [Sharing files with Virtiofs](https://libvirt.org/kbase/virtiofs.html)
- [Documentation/9psetup](https://wiki.qemu.org/Documentation/9psetup)
- [Libvirt](https://discourse.ubuntu.com/t/libvirt/11522)
- [Share Folder Between Guest and Host in virt-manager (KVM/Qemu/libvirt)](https://www.debugpoint.com/share-folder-virt-manager/)
- [Share Files Between KVM Host and Linux Guest Using Virtiofs](https://sysguides.com/share-files-between-kvm-host-and-linux-guest-using-virtiofs/)
- [Using file system passthrough with KVM guests](https://askubuntu.com/questions/1014674/using-file-system-passthrough-with-kvm-guests)
- [The new shared folder implementation appears to be virtio-9p/"virtfs" rather than virtiofs.](https://github.com/utmapp/UTM/issues/4386#issuecomment-1242033554)
- [Mount Device With Specific User Rights](https://www.baeldung.com/linux/mount-user-rights)

### Windows guest

## GPU passthrough

### Windows guest

*References*:

- [Configuring GPU Pass-Through for NVIDIA cards](https://doc.opensuse.org/documentation/leap/virtualization/html/book-virtualization/app-gpu-passthru.html)

[//begin]: # "Autogenerated link references for markdown compatibility"
[Tumbleweed/dev_env#KVM]: ../openSUSE/Tumbleweed/dev_env.md "OpenSUSE Tumbleweed Development Environment"
[//end]: # "Autogenerated link references"
